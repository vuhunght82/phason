<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paint Mixer AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#4f46e5',
                        'brand-secondary': '#7c3aed',
                        'brand-yellow': '#facc15',
                        'base-100': '#1f2937',
                        'base-200': '#374151',
                        'base-300': '#4b5563',
                        'content-100': '#f3f4f6',
                        'content-200': '#d1d5db',
                    },
                },
            },
        };
    </script>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-base-100">
    <div id="root"></div>

    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        // --- STATE MANAGEMENT ---
        let state = {
            selectedColor: { name: 'Deep Purple', hex: '#800080' },
            quantity: 1000,
            unit: 'g',
            formula: null,
            isLoading: false,
            error: null,
            uploadedImage: null,
            isPickerOpen: false,
            customColor: null,
            compensateForGlass: true,
            glassThickness: 5,
            language: 'en',
        };

        // --- TRANSLATIONS (i18n) ---
        const translations = {
            en: {
                "appTitle": "Paint Mixer AI",
                "appDescription": "Select a color, specify the amount, and let AI generate the mixing formula.",
                "footerText": "© {year} Paint Mixer AI. Powered by Google Gemini.",
                "step1Title": "1. Select Target Color",
                "paletteHeader": "From Palette",
                "uploadHeader": "Or Upload an Image",
                "step2Title": "2. Set Quantity",
                "step3Title": "3. View Formula",
                "customColorName": "Custom",
                "uploadButton": "Upload Image",
                "totalAmountLabel": "Total Amount",
                "quantityPlaceholder": "e.g., 1000",
                "unitLabel": "Unit",
                "unitWeight": "Weight (g)",
                "unitVolume": "Volume (ml)",
                "glassCompensationLabel": "Compensate for Glass Tint",
                "glassCompensationDescription": "Adjusts formula for glass's natural green color.",
                "glassThicknessLabel": "Glass Thickness",
                "generateButton": "Generate Formula",
                "generatingButton": "Generating Formula...",
                "errorSelectColor": "Please select a color first.",
                "errorInvalidQuantity": "Please enter a valid quantity.",
                "errorApiFailure": "Failed to generate formula. The AI might be busy. Please try again.",
                "resultLoading": "AI is mixing the colors...",
                "resultErrorTitle": "An Error Occurred",
                "resultPlaceholderTitle": "Your formula will appear here.",
                "resultPlaceholderDescription": "Complete the steps to get started.",
                "resultFormulaFor": "Formula for",
                "pickerTitle": "Pick a Color",
                "pickerHovering": "Hovering:",
                "pickerInstructions": "Move cursor over image and click to select a color.",
                "pickerCancel": "Cancel",
                "customColorTitle": "Custom ({hex})"
            },
            vi: {
                "appTitle": "AI Pha Sơn",
                "appDescription": "Chọn màu, nhập số lượng, và để AI tạo công thức pha màu.",
                "footerText": "© {year} AI Pha Sơn. Hỗ trợ bởi Google Gemini.",
                "step1Title": "1. Chọn Màu Mục Tiêu",
                "paletteHeader": "Từ Bảng Màu",
                "uploadHeader": "Hoặc Tải Ảnh Lên",
                "step2Title": "2. Thiết Lập Số Lượng",
                "step3Title": "3. Xem Công Thức",
                "customColorName": "Tùy chỉnh",
                "uploadButton": "Tải Ảnh Lên",
                "totalAmountLabel": "Tổng Số Lượng",
                "quantityPlaceholder": "ví dụ: 1000",
                "unitLabel": "Đơn Vị",
                "unitWeight": "Khối lượng (g)",
                "unitVolume": "Thể tích (ml)",
                "glassCompensationLabel": "Bù Trừ Màu Kính",
                "glassCompensationDescription": "Điều chỉnh công thức cho màu xanh tự nhiên của kính.",
                "glassThicknessLabel": "Độ Dày Kính",
                "generateButton": "Tạo Công Thức",
                "generatingButton": "Đang tạo công thức...",
                "errorSelectColor": "Vui lòng chọn một màu trước.",
                "errorInvalidQuantity": "Vui lòng nhập số lượng hợp lệ.",
                "errorApiFailure": "Không thể tạo công thức. AI có thể đang bận. Vui lòng thử lại.",
                "resultLoading": "AI đang pha màu...",
                "resultErrorTitle": "Đã Xảy Ra Lỗi",
                "resultPlaceholderTitle": "Công thức của bạn sẽ hiện ở đây.",
                "resultPlaceholderDescription": "Hoàn thành các bước để bắt đầu.",
                "resultFormulaFor": "Công thức cho",
                "pickerTitle": "Chọn một màu",
                "pickerHovering": "Màu đang trỏ:",
                "pickerInstructions": "Di chuyển con trỏ trên ảnh và nhấp để chọn màu.",
                "pickerCancel": "Hủy",
                "customColorTitle": "Tùy chỉnh ({hex})"
            }
        };

        function t(key, replacements = {}) {
            let translation = translations[state.language][key] || key;
            Object.keys(replacements).forEach(placeholder => {
                const regex = new RegExp(`{${placeholder}}`, 'g');
                translation = translation.replace(regex, String(replacements[placeholder]));
            });
            return translation;
        }

        function setLanguage(lang) {
            state.language = lang;
            localStorage.setItem('language', lang);
            renderApp();
        }

        // --- CONSTANTS ---
        const BASE_COLORS = [
            { name: "Red", hex: "#FF0000" }, { name: "Yellow", hex: "#FFFF00" },
            { name: "Blue", hex: "#0000FF" }, { name: "White", hex: "#FFFFFF" },
            { name: "Black", hex: "#000000" }, { name: "Magenta", hex: "#FF00FF" },
            { name: "Cyan", hex: "#00FFFF" }, { name: "Green", hex: "#008000" },
            { name: "Orange", hex: "#FFA500" }, { name: "Purple", hex: "#800080" }
        ];

        const TARGET_COLORS = [
            { name: 'Royal Blue', hex: '#4169E1' }, { name: "Forest Green", hex: "#228B22" },
            { name: 'Crimson Red', hex: '#DC143C' }, { name: 'Sunny Yellow', hex: '#FFD700' },
            { name: 'Deep Purple', hex: '#800080' }, { name: 'Tangerine Orange', hex: '#FFA500' },
            { name: 'Sky Blue', hex: '#87CEEB' }, { name: 'Mint Green', hex: '#98FF98' },
            { name: 'Lavender', hex: '#E6E6FA' }, { name: 'Chocolate Brown', hex: '#D2691E' },
            { name: 'Charcoal Gray', hex: '#36454F' }, { name: 'Beige', hex: '#F5F5DC' },
            { name: 'Teal', hex: '#008080' }, { name: 'Maroon', hex: '#800000' },
            { name: 'Olive Green', hex: '#808000' }, { name: 'Salmon Pink', hex: '#FA8072' },
        ];
        
        const GLASS_THICKNESSES = [3, 4, 5, 6, 8, 10];

        // --- GEMINI SERVICE ---
        const API_KEY = process.env.API_KEY;
        if (!API_KEY) {
            document.getElementById('root').innerHTML = `<div class="p-4 text-red-400">API_KEY environment variable not set. Please configure it to use the application.</div>`;
            throw new Error("API_KEY not set");
        }
        const ai = new GoogleGenAI({ apiKey: API_KEY });

        async function getPaintFormula(colorName, colorHex, compensateForGlass, glassThickness) {
            const baseColorNames = BASE_COLORS.map(c => c.name);
            const schemaProperties = baseColorNames.reduce((acc, color) => {
                acc[color] = {
                    type: Type.NUMBER,
                    description: `The percentage of ${color} paint required. Should be 0 if not used.`,
                };
                return acc;
            }, {});

            try {
                let prompt = `You are an expert paint mixing chemist. Your task is to provide a precise mixing formula to create the color "${colorName}"${colorHex ? ` with the hex code ${colorHex}` : ''}.
                  You must use only the following available base colors: ${baseColorNames.join(', ')}.
                  The formula must be represented as percentages. The sum of all percentages in the formula must equal 100.
                  If a base color is not needed, its value must be 0.`;

                if (compensateForGlass) {
                    prompt += `\n\nIMPORTANT CONTEXT: This paint will be applied onto standard clear float glass used in construction. The selected glass thickness is ${glassThickness}mm.
This type of glass has a natural, subtle green tint due to its iron oxide (FeO) content, and this tint is more pronounced in thicker glass.
The generated formula MUST compensate for this green tint based on the specified thickness. A thicker glass (e.g., 10mm) requires more color correction than a thinner one (e.g., 3mm). The goal is for the final appearance of the color *after being applied to the ${glassThickness}mm glass* to match the target color "${colorName}" (${colorHex}). The paint itself in liquid form might need a slight tint adjustment (e.g., adding a bit of its complementary color, magenta/red) to neutralize the glass's green cast. Your final formula should reflect this professional adjustment.`;
                }

                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: prompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                formula: {
                                    type: Type.OBJECT,
                                    description: "An object where keys are the base color names and values are their percentage contribution.",
                                    properties: schemaProperties,
                                },
                                totalPercentage: {
                                    type: Type.NUMBER,
                                    description: "The sum of all percentages in the formula. This must be exactly 100."
                                }
                            },
                            required: ["formula", "totalPercentage"],
                        },
                        temperature: 0.2,
                    },
                });

                const textResponse = response.text?.trim();
                if (!textResponse) throw new Error("Received an empty response from the API.");
                
                const parsedJson = JSON.parse(textResponse);
                if (!parsedJson.formula || typeof parsedJson.formula !== 'object') throw new Error("Invalid formula format in API response.");

                return parsedJson.formula;

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw new Error(`Failed to get paint formula from AI for color: ${colorName}`);
            }
        }
        
        // --- EVENT HANDLERS ---
        window.handleSelectColor = (name, hex) => {
            state.selectedColor = { name, hex };
            renderApp();
        };

        window.handleSetQuantity = (value) => {
            state.quantity = value === '' ? 0 : parseFloat(value) || 0;
            renderApp();
        };
        
        window.handleSetUnit = (unit) => {
            state.unit = unit;
            renderApp();
        };
        
        window.handleSetCompensate = (value) => {
            state.compensateForGlass = value;
            renderApp();
        };

        window.handleSetThickness = (value) => {
            state.glassThickness = value;
            renderApp();
        };

        window.handleImageUpload = (event) => {
            const file = event.target.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (typeof e.target?.result === 'string') {
                        state.uploadedImage = e.target.result;
                        state.isPickerOpen = true;
                        renderApp();
                    }
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        };

        window.handleColorSelectFromImage = (hex) => {
            const newCustomColor = { name: t('customColorTitle', { hex }), hex };
            state.customColor = newCustomColor;
            state.selectedColor = newCustomColor;
            state.isPickerOpen = false;
            renderApp();
        };

        window.closePicker = () => {
            state.isPickerOpen = false;
            renderApp();
        };
        
        window.handleCalculate = async () => {
            if (!state.selectedColor) {
                state.error = t('errorSelectColor');
                renderApp();
                return;
            }
            if (state.quantity <= 0) {
                state.error = t('errorInvalidQuantity');
                renderApp();
                return;
            }
        
            state.isLoading = true;
            state.error = null;
            state.formula = null;
            renderApp();
        
            try {
                const generatedFormula = await getPaintFormula(state.selectedColor.name, state.selectedColor.hex, state.compensateForGlass, state.glassThickness);
                state.formula = generatedFormula;
            } catch (err) {
                console.error(err);
                state.error = t('errorApiFailure');
            } finally {
                state.isLoading = false;
                renderApp();
            }
        };

        // --- RENDER FUNCTIONS ---
        const PaintBrushIcon = (props) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="${props.className}"><path fill-rule="evenodd" d="M19.5 3.75a3 3 0 00-3-3h-1.5a3 3 0 00-3 3v.75H6a3 3 0 00-3 3v9.75a3 3 0 003 3h9.75a3 3 0 003-3v-9.75a3 3 0 00-3-3h-1.5V6.75a.75.75 0 011.5 0v.75a.75.75 0 001.5 0V3.75zM12.75 12a.75.75 0 00-1.5 0v2.25a.75.75 0 001.5 0V12zM10.5 10.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>`;
        const LoadingIcon = (props) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="${props.className}"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        const UploadIcon = (props) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${props.className}"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>`;
        const EyeDropperIcon = (props) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${props.className}"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9zm3.75 11.625a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>`;
        
        function renderLanguageSwitcher() {
            const buttonClasses = (lang) => `px-3 py-1 text-sm font-medium rounded-md transition-colors ${state.language === lang ? 'bg-brand-primary text-white' : 'text-content-200 hover:bg-base-300'}`;
            return `
                <div class="flex items-center space-x-2 bg-base-200 p-1 rounded-lg">
                    <button onclick="setLanguage('en')" class="${buttonClasses('en')}">English</button>
                    <button onclick="setLanguage('vi')" class="${buttonClasses('vi')}">Tiếng Việt</button>
                </div>
            `;
        }

        function renderColorPalette() {
            return TARGET_COLORS.map(color => `
                <div 
                  onclick="handleSelectColor('${color.name.replace(/'/g, "\\'")}', '${color.hex}')"
                  class="cursor-pointer group flex flex-col items-center gap-2"
                  title="${color.name}">
                    <div class="w-16 h-16 rounded-full shadow-md transition-all duration-300 transform group-hover:scale-110 ${state.selectedColor?.hex === color.hex ? 'ring-4 ring-offset-2 ring-offset-base-200 ring-brand-primary' : 'ring-2 ring-transparent'}"
                         style="background-color: ${color.hex};">
                    </div>
                    <span class="text-xs text-center transition-colors ${state.selectedColor?.hex === color.hex ? 'text-brand-primary font-semibold' : 'text-content-200'}">
                        ${color.name}
                    </span>
                </div>
            `).join('');
        }

        function renderCustomColorPicker() {
            const isSelected = !!state.customColor && state.selectedColor?.hex === state.customColor.hex;
            return `
                <div class="flex items-center gap-4">
                    <input type="file" id="fileInput" onchange="handleImageUpload(event)" class="hidden" accept="image/png, image/jpeg, image/jpg" />
                    <button onclick="document.getElementById('fileInput').click()"
                            class="flex flex-col items-center justify-center w-28 h-20 bg-base-300 rounded-lg border-2 border-dashed border-base-100 hover:border-brand-primary transition-colors text-content-200 hover:text-brand-primary">
                        ${UploadIcon({ className: 'w-6 h-6 mb-1' })}
                        <span class="text-xs text-center font-medium">${t('uploadButton')}</span>
                    </button>
                    ${state.customColor ? `
                        <div onclick="handleSelectColor('${state.customColor.name.replace(/'/g, "\\'")}', '${state.customColor.hex}')" class="cursor-pointer group flex flex-col items-center gap-2" title="${state.customColor.name}">
                            <div class="w-16 h-16 rounded-full shadow-md transition-all duration-300 transform group-hover:scale-110 ${isSelected ? 'ring-4 ring-offset-2 ring-offset-base-200 ring-brand-primary' : 'ring-2 ring-transparent'}"
                                 style="background-color: ${state.customColor.hex};">
                            </div>
                            <span class="text-xs text-center transition-colors ${isSelected ? 'text-brand-primary font-semibold' : 'text-content-200'}">
                                ${t('customColorName')}
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function renderCalculatorForm() {
            return `
                <div class="space-y-6">
                    <div class="relative">
                        <label for="quantity" class="block text-sm font-medium text-content-200 mb-1">${t('totalAmountLabel')}</label>
                        <input type="number" id="quantity" value="${state.quantity === 0 ? '' : state.quantity}" oninput="handleSetQuantity(this.value)"
                               placeholder="${t('quantityPlaceholder')}" class="w-full bg-base-300 text-content-100 placeholder-content-200/50 rounded-lg py-3 px-4 focus:ring-2 focus:ring-brand-primary focus:outline-none transition" />
                        <div class="absolute inset-y-0 right-0 top-6 flex items-center pr-3">
                            <span class="text-content-200">${state.unit}</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-content-200 mb-2">${t('unitLabel')}</label>
                        <div class="flex space-x-2 bg-base-300 p-1 rounded-lg">
                            <button onclick="handleSetUnit('g')" class="w-full py-2 rounded-md text-sm font-semibold transition-colors ${state.unit === 'g' ? 'bg-brand-primary text-white' : 'text-content-200 hover:bg-base-100/50'}">${t('unitWeight')}</button>
                            <button onclick="handleSetUnit('ml')" class="w-full py-2 rounded-md text-sm font-semibold transition-colors ${state.unit === 'ml' ? 'bg-brand-primary text-white' : 'text-content-200 hover:bg-base-100/50'}">${t('unitVolume')}</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-base-300 rounded-lg">
                        <div>
                            <label class="font-medium text-content-100">${t('glassCompensationLabel')}</label>
                            <p class="text-xs text-content-200/80">${t('glassCompensationDescription')}</p>
                        </div>
                        <button type="button" role="switch" aria-checked="${state.compensateForGlass}" onclick="handleSetCompensate(!${state.compensateForGlass})" class="${state.compensateForGlass ? 'bg-brand-primary' : 'bg-base-100'} relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2 focus:ring-offset-base-200">
                            <span aria-hidden="true" class="${state.compensateForGlass ? 'translate-x-5' : 'translate-x-0'} pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>
                    ${state.compensateForGlass ? `
                        <div>
                            <label class="block text-sm font-medium text-content-200 mb-2">${t('glassThicknessLabel')}</label>
                            <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 bg-base-300 p-1 rounded-lg">
                                ${GLASS_THICKNESSES.map(thickness => `
                                    <button onclick="handleSetThickness(${thickness})" class="py-2 rounded-md text-xs font-semibold transition-colors ${state.glassThickness === thickness ? 'bg-brand-primary text-white' : 'text-content-200 hover:bg-base-100/50'}">
                                        ${thickness} mm
                                    </button>
                                `).join('')}
                            </div>
                        </div>` : ''
                    }
                    <button onclick="handleCalculate()" ${state.isLoading || !state.selectedColor || state.quantity <= 0 ? 'disabled' : ''} class="w-full flex items-center justify-center bg-gradient-to-r from-brand-primary to-brand-secondary text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105">
                        ${state.isLoading ? `${LoadingIcon({ className: 'animate-spin -ml-1 mr-3 h-5 w-5 text-white' })} ${t('generatingButton')}` : t('generateButton')}
                    </button>
                </div>
            `;
        }
        
        function renderResultDisplay() {
            if (state.isLoading) {
                return `<div class="flex flex-col items-center justify-center h-full text-content-200">
                            <div class="w-20 h-20 border-4 border-dashed rounded-full animate-spin border-brand-primary"></div>
                            <p class="mt-4 text-lg">${t('resultLoading')}</p>
                        </div>`;
            }
            if (state.error) {
                return `<div class="flex flex-col items-center justify-center h-full text-red-400">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                           <p class="font-semibold">${t('resultErrorTitle')}</p>
                           <p class="text-sm text-center">${state.error}</p>
                        </div>`;
            }
            if (!state.formula) {
                return `<div class="flex flex-col items-center justify-center h-full text-content-200">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                           <p class="text-lg">${t('resultPlaceholderTitle')}</p>
                           <p class="text-sm text-center">${t('resultPlaceholderDescription')}</p>
                        </div>`;
            }
            const baseColorHexMap = new Map(BASE_COLORS.map(c => [c.name, c.hex]));
            const validIngredients = Object.entries(state.formula).map(([color, percentage]) => [color, Number(percentage)]).filter(([, percentage]) => percentage > 0);
            const totalPercentage = validIngredients.reduce((sum, [, percentage]) => sum + percentage, 0);

            return `<div class="space-y-4">
                <div class="flex items-center gap-4 p-3 bg-base-300 rounded-lg">
                    <div class="w-10 h-10 rounded-full" style="background-color: ${state.selectedColor?.hex};"></div>
                    <div>
                        <p class="text-sm text-content-200">${t('resultFormulaFor')}</p>
                        <p class="font-bold text-lg text-content-100">${state.selectedColor?.name}</p>
                    </div>
                </div>
                <ul class="space-y-2">
                    ${validIngredients.map(([color, percentage]) => {
                        const normalizedPercentage = totalPercentage > 0 ? percentage / totalPercentage : 0;
                        const amount = (state.quantity * normalizedPercentage).toFixed(2);
                        const colorHex = baseColorHexMap.get(color) || '#808080';
                        return `
                            <li class="flex justify-between items-center p-3 bg-base-100/50 rounded-md">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded-full ring-1 ring-base-300" style="background-color: ${colorHex};"></div>
                                    <span class="font-medium text-content-100">${color}</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-brand-yellow">${amount} ${state.unit}</span>
                                    <span class="text-sm text-brand-yellow/80 ml-2">(${percentage.toFixed(1)}%)</span>
                                </div>
                            </li>`;
                    }).join('')}
                </ul>
            </div>`;
        }

        function renderImageColorPicker() {
            if (!state.isPickerOpen || !state.uploadedImage) return '';
            
            return `
                <div class="fixed inset-0 bg-base-100/80 backdrop-blur-sm flex items-center justify-center z-50" onclick="closePicker()">
                    <div class="bg-base-200 rounded-2xl shadow-2xl p-6 w-full max-w-4xl h-[80vh] max-h-[800px] flex flex-col gap-4" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center border-b border-base-300 pb-3">
                            <div class="flex items-center gap-3">
                                ${EyeDropperIcon({ className: 'w-6 h-6 text-brand-primary' })}
                                <h2 class="text-xl font-bold">${t('pickerTitle')}</h2>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-sm text-content-200">${t('pickerHovering')}</span>
                                <div id="color-preview" class="w-8 h-8 rounded-full border-2 border-content-100" style="background-color: #FFFFFF;"></div>
                                <span id="color-hex" class="font-mono text-content-100">#FFFFFF</span>
                            </div>
                        </div>
                        <div class="flex-grow flex items-center justify-center overflow-hidden">
                            <canvas id="color-picker-canvas" class="cursor-crosshair rounded-lg shadow-md"></canvas>
                        </div>
                        <div class="flex justify-end items-center gap-4 pt-4 border-t border-base-300">
                            <p class="text-sm text-content-200 mr-auto">${t('pickerInstructions')}</p>
                            <button onclick="closePicker()" class="py-2 px-5 rounded-lg bg-base-300 hover:bg-base-100/50 transition-colors">${t('pickerCancel')}</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function setupImageColorPicker() {
             if (!state.isPickerOpen || !state.uploadedImage) return;

             const canvas = document.getElementById('color-picker-canvas');
             const ctx = canvas?.getContext('2d', { willReadFrequently: true });
             if (!canvas || !ctx) return;

             const image = new Image();
             image.crossOrigin = "Anonymous";
             image.src = state.uploadedImage;
             image.onload = () => {
                 const container = canvas.parentElement;
                 if (container) {
                    const containerWidth = container.clientWidth;
                    const containerHeight = container.clientHeight;
                    const imgAspectRatio = image.width / image.height;
                    const containerAspectRatio = containerWidth / containerHeight;

                    let drawWidth, drawHeight;
                    if (imgAspectRatio > containerAspectRatio) {
                        drawWidth = containerWidth;
                        drawHeight = containerWidth / imgAspectRatio;
                    } else {
                        drawHeight = containerHeight;
                        drawWidth = containerHeight * imgAspectRatio;
                    }
                    
                    canvas.width = drawWidth;
                    canvas.height = drawHeight;
                    ctx.drawImage(image, 0, 0, drawWidth, drawHeight);
                 }
             };

             const pickColor = (event) => {
                 const rect = canvas.getBoundingClientRect();
                 const x = event.clientX - rect.left;
                 const y = event.clientY - rect.top;
                 const pixel = ctx.getImageData(x, y, 1, 1).data;
                 const toHex = (c) => ('0' + c.toString(16)).slice(-2);
                 return `#${toHex(pixel[0])}${toHex(pixel[1])}${toHex(pixel[2])}`.toUpperCase();
             };

             canvas.onmousemove = (event) => {
                 const hex = pickColor(event);
                 if(hex) {
                    document.getElementById('color-preview').style.backgroundColor = hex;
                    document.getElementById('color-hex').textContent = hex;
                 }
             };

             canvas.onclick = (event) => {
                 const hex = pickColor(event);
                 if (hex) handleColorSelectFromImage(hex);
             };
        }

        function renderApp() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="min-h-screen bg-base-100 text-content-100 font-sans flex flex-col items-center p-4 sm:p-6 lg:p-8">
                    <div class="w-full max-w-6xl mx-auto">
                        <header class="text-center mb-8">
                            <div class="flex items-center justify-center gap-4 mb-2">
                                ${PaintBrushIcon({ className: 'w-10 h-10 text-brand-primary' })}
                                <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-brand-primary to-brand-secondary">${t('appTitle')}</h1>
                            </div>
                            <p class="text-lg text-content-200">${t('appDescription')}</p>
                        </header>
                        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-base-200 p-6 rounded-2xl shadow-lg">
                                <h2 class="text-2xl font-semibold mb-4 border-b border-base-300 pb-3">${t('step1Title')}</h2>
                                <h3 class="text-lg font-medium text-content-200 mb-3">${t('paletteHeader')}</h3>
                                <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                    ${renderColorPalette()}
                                </div>
                                <div class="mt-6 border-t border-base-300 pt-4">
                                    <h3 class="text-lg font-medium text-content-200 mb-3">${t('uploadHeader')}</h3>
                                    ${renderCustomColorPicker()}
                                </div>
                            </div>
                            <div class="flex flex-col gap-8">
                                <div class="bg-base-200 p-6 rounded-2xl shadow-lg">
                                    <h2 class="text-2xl font-semibold mb-4 border-b border-base-300 pb-3">${t('step2Title')}</h2>
                                    ${renderCalculatorForm()}
                                </div>
                                <div class="bg-base-200 p-6 rounded-2xl shadow-lg flex-grow">
                                    <h2 class="text-2xl font-semibold mb-4 border-b border-base-300 pb-3">${t('step3Title')}</h2>
                                    <div class="h-full min-h-[200px]">${renderResultDisplay()}</div>
                                </div>
                            </div>
                        </main>
                        <footer class="text-center mt-12 text-content-200 text-sm flex flex-col items-center gap-4">
                            ${renderLanguageSwitcher()}
                            <p>${t('footerText', { year: new Date().getFullYear() })}</p>
                        </footer>
                    </div>
                </div>
                ${renderImageColorPicker()}
            `;
            
            // Post-render setup for canvas
            if (state.isPickerOpen) {
                setupImageColorPicker();
            }
        }

        // --- INITIALIZATION ---
        const storedLang = localStorage.getItem('language');
        if (storedLang === 'en' || storedLang === 'vi') {
            state.language = storedLang;
        }
        
        // Expose functions to global scope so inline handlers can find them
        window.setLanguage = setLanguage;
        window.handleCalculate = handleCalculate;

        renderApp();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
